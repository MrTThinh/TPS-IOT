<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>ESP32 Smart Health Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.5">

  <!-- CSS ngo√†i -->
  <link rel="stylesheet" href="style.css">

  <!-- Chart.js ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<script src="main.js"></script> <!--Th√™m-->
<body>

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="header-left">
        <div class="logo-circle">‚ù§</div>
        <div>
          <div class="header-title">e-Health Dashboard</div>
        </div>
      </div>
      <div class="header-right">
    
        <!-- Con m·∫Øt-->
        <div class="face">
          <div class="eye">
            <div class="pupil"></div>
          </div>
          <div class="eye">
            <div class="pupil"></div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- BANNER -->
  <div id="banner">
    <div class="banner-inner">
      <div>üïí C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdateText">--:--</span></div>
    </div>
  </div>

  <!-- NAV TABS -->
  <div class="nav-tabs">
    <button class="tab-btn active" data-target="tab-overview">1. T·ªïng quan</button>
    <button class="tab-btn" data-target="tab-heart">2. Nh·ªãp tim</button>
    <button class="tab-btn" data-target="tab-spo2">3. SpO‚ÇÇ</button>
    <button class="tab-btn" data-target="tab-temp">4. Nhi·ªát ƒë·ªô c∆° th·ªÉ</button>
    <button class="tab-btn" data-target="tab-data">5. File data ESP</button>
  </div>

  <!-- MAIN -->
  <main>

    <!-- TAB 1: T·ªîNG QUAN -->
    <section id="tab-overview" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">T·ªïng quan s·ª©c kh·ªèe</div>
          </div>
        </div>

        <div class="grid-3">
          <!-- Nh·ªãp tim -->
          <div class="metric-card">
            <div class="metric-top">
              <div class="metric-left">
                <div class="metric-icon">
                <img src="heart.gif" alt="Nh·ªãp tim" class="logo-gif"></div>

                <div>
                  <div class="metric-label">Nh·ªãp tim</div>
                  <div><span id="hrValue" class="metric-value">--</span><span class="metric-unit">BPM</span></div>
                </div>
              </div>
            </div>
            <div class="metric-footer">Kho·∫£ng tham chi·∫øu: 60 ‚Äì 100 BPM</div>
          </div>

          <!-- SpO2 -->
          <div class="metric-card">
            <div class="metric-top">
              <div class="metric-left">
                <div class="metric-icon">
                  <img src="oxy.gif" alt="SpO‚ÇÇ" class="logo-gif"></div>

                <div>
                  <div class="metric-label">SpO‚ÇÇ</div>
                  <div><span id="spo2Value" class="metric-value">--</span><span class="metric-unit">%</span></div>
                </div>
              </div>
            </div>
            <div class="metric-footer">B√¨nh th∆∞·ªùng: &gt;= 95%</div>
          </div>

          <!-- Nhi·ªát ƒë·ªô -->
          <div class="metric-card">
            <div class="metric-top">
              <div class="metric-left">
                <div class="metric-icon">
                  <img src="tom.gif" alt="Nhi·ªát ƒë·ªô" class="logo-gif">
                </div>
                <div>
                  <div class="metric-label">Nhi·ªát ƒë·ªô c∆° th·ªÉ</div>
                  <div><span id="tempValue" class="metric-value">--</span><span class="metric-unit">¬∞C</span></div>
                </div>
              </div>
            </div>
            <div class="metric-footer">B√¨nh th∆∞·ªùng ~ 36.5 ‚Äì 37.5¬∞C</div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 2: NH·ªäP TIM -->
    <section id="tab-heart" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Nh·ªãp tim chi ti·∫øt</div>
            <div class="card-subtitle">Bi·ªÉu ƒë·ªì bi·∫øn thi√™n nh·ªãp tim theo th·ªùi gian</div>
          </div>
          <span class="pill">Heart Rate</span>
        </div>

        <div class="metrics-row">
          <div class="mini-metric">Hi·ªán t·∫°i: <span id="hrCurrent">--</span> BPM</div>
          <div class="mini-metric">Trung b√¨nh: <span id="hrAvg">--</span> BPM</div>
          <div class="mini-metric">Min: <span id="hrMin">--</span> BPM</div>
          <div class="mini-metric">Max: <span id="hrMax">--</span> BPM</div>
        </div>

        <iframe
          width="600"
          height="300"
          src="https://thingspeak.mathworks.com/channels/3214452/charts/1?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=20&title=Heart+Rate&type=line">
        </iframe>
        <canvas id="hrChart" height="110"></canvas>
      </div>
    </section>

    <!-- TAB 3: SPO2 -->
    <section id="tab-spo2" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">SpO‚ÇÇ chi ti·∫øt</div>
            <div class="card-subtitle">Theo d√µi n·ªìng ƒë·ªô oxy trong m√°u</div>
          </div>
          <span class="pill">SpO‚ÇÇ</span>
        </div>

        <div class="metrics-row">
          <div class="mini-metric">Hi·ªán t·∫°i: <span id="spo2Current">--</span>%</div>
          <div class="mini-metric">Trung b√¨nh: <span id="spo2Avg">--</span>%</div>
          <div class="mini-metric">Min: <span id="spo2Min">--</span>%</div>
          <div class="mini-metric">Max: <span id="spo2Max">--</span>%</div>
        </div>

        <iframe
          width="600"
          height="300"
          src="https://thingspeak.mathworks.com/channels/3214452/charts/2?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=20&title=SpO2&type=line">
        </iframe>

        <canvas id="spo2Chart" height="110"></canvas>
      </div>
    </section>

    <!-- TAB 4: NHI·ªÜT ƒê·ªò -->
    <section id="tab-temp" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Nhi·ªát ƒë·ªô c∆° th·ªÉ chi ti·∫øt</div>
            <div class="card-subtitle">Theo d√µi nhi·ªát ƒë·ªô v√† ph√°t hi·ªán s·ªët</div>
          </div>
          <span class="pill">Temperature</span>
        </div>

        <div class="metrics-row">
          <div class="mini-metric">Hi·ªán t·∫°i: <span id="tempCurrent">--</span>¬∞C</div>
          <div class="mini-metric">Trung b√¨nh: <span id="tempAvg">--</span>¬∞C</div>
          <div class="mini-metric">Min: <span id="tempMin">--</span>¬∞C</div>
          <div class="mini-metric">Max: <span id="tempMax">--</span>¬∞C</div>
        </div>

        <iframe
          width="600"
          height="300"
          src="https://thingspeak.mathworks.com/channels/3214452/charts/3?bgcolor=%23ffffff&color=%23d62020&dynamic=true&results=20&title=Temperature&type=line">
        </iframe>

        <canvas id="tempChart" height="110"></canvas>
      </div>
    </section>

    <!-- TAB 5: FILE DATA ESP -->
    <section id="tab-data" class="tab-content">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">File d·ªØ li·ªáu do ESP t·∫£i l√™n</div>
            <div class="card-subtitle">Demo b·∫£ng d·ªØ li·ªáu ‚Äì sau n√†y thay b·∫±ng d·ªØ li·ªáu th·∫≠t t·ª´ Firebase / server</div>
          </div>
          <button class="btn-outline" onclick="downloadCsvDemo()">‚¨á T·∫£i CSV (demo)</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>Nh·ªãp tim (BPM)</th>
              <th>SpO‚ÇÇ (%)</th>
              <th>Nhi·ªát ƒë·ªô (¬∞C)</th>
            </tr>
          </thead>
          <tbody id="dataTableBody">
            <!-- JS s·∫Ω ƒëi·ªÅn d·ªØ li·ªáu demo -->
          </tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-inner">
      <span>M·ªçi th√¥ng tin li√™n h·ªá: 23139039@student.hcmute.edu.vn</span>
      <span>ƒê·ªó Thanh S∆°n</span>
      <span>Hu·ª≥nh Tr·∫ßn Ti·∫øn Th·ªãnh</span>
      <span>Ho√†ng Gia Ph√°t - Leader</span>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    // ----- TAB SWITCH -----
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));

        btn.classList.add('active');
        const targetId = btn.getAttribute('data-target');
        document.getElementById(targetId).classList.add('active');
      });
    });

  // ----- D·ªÆ LI·ªÜU TH·∫¨T (s·∫Ω nh·∫≠n t·ª´ Firebase) -----
window.labels   = [];
window.hrData   = [];
window.spo2Data = [];
window.tempData = [];

// alias ƒë·ªÉ ph√≠a d∆∞·ªõi d√πng cho g·ªçn
const labels   = window.labels;
const hrData   = window.hrData;
const spo2Data = window.spo2Data;
const tempData = window.tempData;


    function updateOverview() {
      const lastIndex = labels.length - 1;
      document.getElementById('hrValue').textContent   = hrData[lastIndex];
      document.getElementById('spo2Value').textContent = spo2Data[lastIndex];
      document.getElementById('tempValue').textContent = tempData[lastIndex];

      document.getElementById('lastUpdateText').textContent = labels[lastIndex];

      // Nh·ªãp tim chi ti·∫øt
      document.getElementById('hrCurrent').textContent = hrData[lastIndex];
      document.getElementById('hrAvg').textContent     = average(hrData).toFixed(0);
      document.getElementById('hrMin').textContent     = Math.min(...hrData);
      document.getElementById('hrMax').textContent     = Math.max(...hrData);

      // SpO2 chi ti·∫øt
      document.getElementById('spo2Current').textContent = spo2Data[lastIndex];
      document.getElementById('spo2Avg').textContent     = average(spo2Data).toFixed(1);
      document.getElementById('spo2Min').textContent     = Math.min(...spo2Data);
      document.getElementById('spo2Max').textContent     = Math.max(...spo2Data);

      // Nhi·ªát ƒë·ªô chi ti·∫øt
      document.getElementById('tempCurrent').textContent = tempData[lastIndex].toFixed(1);
      document.getElementById('tempAvg').textContent     = average(tempData).toFixed(2);
      document.getElementById('tempMin').textContent     = Math.min(...tempData).toFixed(1);
      document.getElementById('tempMax').textContent     = Math.max(...tempData).toFixed(1);
    }

    function average(arr) {
      return arr.reduce((a, b) => a + b, 0) / arr.length;
    }

    // ----- BI·ªÇU ƒê·ªí -----
    let hrChart, spo2Chart, tempChart;

    function createCharts() {
      const hrCtx   = document.getElementById('hrChart').getContext('2d');
      const spo2Ctx = document.getElementById('spo2Chart').getContext('2d');
      const tempCtx = document.getElementById('tempChart').getContext('2d');

      hrChart = new Chart(hrCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Nh·ªãp tim (BPM)',
            data: hrData,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: false }
          }
        }
      });

      spo2Chart = new Chart(spo2Ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'SpO‚ÇÇ (%)',
            data: spo2Data,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              suggestedMin: 90,
              suggestedMax: 100
            }
          }
        }
      });

      tempChart = new Chart(tempCtx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Nhi·ªát ƒë·ªô (¬∞C)',
            data: tempData,
            fill: false,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              suggestedMin: 35,
              suggestedMax: 40
            }
          }
        }
      });
    }

    // ----- B·∫¢NG DATA (TAB 5) -----
    function loadTableData() {
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';
      for (let i = 0; i < labels.length; i++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${labels[i]}</td>
          <td>${hrData[i]}</td>
          <td>${spo2Data[i]}</td>
          <td>${tempData[i].toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // T·∫£i CSV demo
    function downloadCsvDemo() {
      let csv = 'time,heart_rate,spo2,temp\n';
      for (let i = 0; i < labels.length; i++) {
        csv += `${labels[i]},${hrData[i]},${spo2Data[i]},${tempData[i]}\n`;
      }
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'esp32_health_data_demo.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    window.downloadCsvDemo = downloadCsvDemo;

    // ----- INIT -----
    window.addEventListener('DOMContentLoaded', () => {
      updateOverview();
      createCharts();
      loadTableData();
    });
  </script>
    <!-- SCRIPT FIREBASE: ƒë·ªçc hrData, spo2Data, tempData ·ªü ROOT DB -->
  <script type="module">
    import { initializeApp } from "";
    import { getDatabase, ref, onValue } from "";

    // ==== D√ÅN CONFIG C·ª¶A ANH V√ÄO ƒê√ÇY (copy t·ª´ Firebase console) ====
    const firebaseConfig = {
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // root ch·ª©a: hrData, spo2Data, tempData
    const latestRef = ref(db, '/');

    function pushNewSampleFromFirebase(data) {
      if (!data) return;

      const time = new Date().toLocaleTimeString('vi-VN').slice(0,5);
      const hr   = Number(data.hrData   ?? 0);
      const spo2 = Number(data.spo2Data ?? 0);
      const temp = Number(data.tempData ?? 0);

      if (!window.labels)   window.labels   = [];
      if (!window.hrData)   window.hrData   = [];
      if (!window.spo2Data) window.spo2Data = [];
      if (!window.tempData) window.tempData = [];

      window.labels.push(time);
      window.hrData.push(hr);
      window.spo2Data.push(spo2);
      window.tempData.push(temp);

      // gi·ªØ t·ªëi ƒëa 20 ƒëi·ªÉm
      const MAX_POINTS = 20;
      if (window.labels.length > MAX_POINTS) {
        window.labels.shift();
        window.hrData.shift();
        window.spo2Data.shift();
        window.tempData.shift();
      }

      // c·∫≠p nh·∫≠t giao di·ªán
      if (window.updateOverview) window.updateOverview();
      if (window.loadTableData)  window.loadTableData();

      if (window.hrChart) {
        window.hrChart.data.labels = window.labels;
        window.hrChart.data.datasets[0].data = window.hrData;
        window.hrChart.update();
      }
      if (window.spo2Chart) {
        window.spo2Chart.data.labels = window.labels;
        window.spo2Chart.data.datasets[0].data = window.spo2Data;
        window.spo2Chart.update();
      }
      if (window.tempChart) {
        window.tempChart.data.labels = window.labels;
        window.tempChart.data.datasets[0].data = window.tempData;
        window.tempChart.update();
      }

      // d√≤ng banner
      const lastUpdateText = document.getElementById('lastUpdateText');
      if (lastUpdateText) lastUpdateText.textContent = time;
    }

    // m·ªói l·∫ßn hrData/spo2Data/tempData tr√™n server ƒë·ªïi ‚Üí update dashboard
    onValue(latestRef, (snapshot) => {
      const data = snapshot.val();
      console.log("Firebase data:", data);
      pushNewSampleFromFirebase(data);
    });
  </script>
</body>
</html>
</body>
</html>
